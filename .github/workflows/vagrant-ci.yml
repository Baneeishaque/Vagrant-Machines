name: Vagrantfile CI Test
on:
  push:
    paths:
      - '**/Vagrantfile'
      
  workflow_dispatch:
    inputs:
      vagrantfile_path:
        description: 'Path to the Vagrantfile to test (relative to repo root)'
        required: false
        default: ''
      box_name:
        description: 'Vagrant Cloud box name (e.g. cloudicio/ubuntu-desktop) to test (overrides vagrantfile_path)'
        required: false
        default: ''

jobs:
  vagrant-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vagrant
        run: .github/scripts/install_vagrant.sh
        shell: bash

      - name: Try to install VirtualBox (best effort)
        run: .github/scripts/install_virtualbox.sh
        shell: bash

      - name: Check Docker availability
        run: .github/scripts/check_docker.sh
        shell: bash

      # QEMU install and caching steps moved up before provider detection
      - name: Calculate apt cache key
        id: aptcachekey
        run: .github/scripts/calc_apt_cache_key.sh
        shell: bash

      - name: Cache apt .deb files
        uses: actions/cache@v4
        with:
          path: .aptcache
          key: ${{ steps.aptcachekey.outputs.key }}
          restore-keys: |
            apt-cache-

      - name: Restore cached .deb files
        run: .github/scripts/restore_apt_cache.sh
        shell: bash

      - name: Install QEMU, libvirt, and dependencies
        id: qemu_apt
        run: .github/scripts/install_qemu_libvirt.sh
        shell: bash

      - name: Save new .deb files to cache
        run: .github/scripts/save_apt_cache.sh
        shell: bash

      - name: Install QEMU from source (fallback)
        if: steps.qemu_apt.outputs.success == 'false'
        uses: arceos-org/setup-qemu@v1.0.2
        with:
          version: '10.1.2'
          targets: 'x86_64,aarch64,arm'

      - name: Detect providers and install plugins
        id: providers
        run: .github/scripts/detect_providers.sh
        shell: bash

      - name: Find Vagrantfiles to test or generate from box
        id: vagrantfiles
        run: |
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          export BOX_NAME="${{ github.event.inputs.box_name }}"
          export VAGRANTFILE_PATH="${{ github.event.inputs.vagrantfile_path }}"
          export GITHUB_BEFORE="${{ github.event.before }}"
          export GITHUB_SHA="${{ github.sha }}"
          .github/scripts/find_vagrantfiles.sh
        shell: bash

      - name: Install jq for box metadata parsing
        run: .github/scripts/install_jq.sh
        shell: bash

      - name: Test Vagrant up/halt/destroy for each provider
        env:
          PROVIDERS: ${{ steps.providers.outputs.providers }}
          FILES: ${{ steps.vagrantfiles.outputs.files }}
        run: .github/scripts/test_vagrantfile_providers.sh
        shell: bash
