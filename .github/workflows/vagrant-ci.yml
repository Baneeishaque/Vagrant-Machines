name: Vagrantfile CI Test
on:
  push:
    paths:
      - '**/Vagrantfile'
      
  workflow_dispatch:
    inputs:
      vagrantfile_path:
        description: 'Path to the Vagrantfile to test (relative to repo root)'
        required: false
        default: ''
      box_name:
        description: 'Vagrant Cloud box name (e.g. cloudicio/ubuntu-desktop) to test (overrides vagrantfile_path)'
        required: false
        default: ''

jobs:
  vagrant-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Vagrant
        run: |
          if ! command -v vagrant >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y curl gnupg lsb-release
              curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt-get update && sudo apt-get install -y vagrant
          fi
          vagrant --version

      - name: Try to install VirtualBox (best effort)
        run: |
          set +e
            sudo apt-get update
            sudo apt-get install -y virtualbox || echo "VirtualBox install failed or not supported"
            set -e
            if command -v vboxmanage >/dev/null 2>&1; then
              echo "VirtualBox available"
            else
              echo "VirtualBox not available"
          fi

      - name: Check Docker availability
        run: |
          if command -v docker >/dev/null 2>&1; then
            echo "Docker available"
          else
            echo "Docker not available"
          fi

      # QEMU install and caching steps moved up before provider detection
      - name: Calculate apt cache key
        id: aptcachekey
        run: |
          aptHash() { echo "$1-$(apt-cache policy "$1" | grep -oP '(?<=Candidate:\s)(.+)')"; }
          export -f aptHash
          hash=$(echo "qemu-system-x86 qemu-system-arm qemu-system-aarch64 qemu-user-static qemu-utils ovmf" | xargs -rI {} bash -c 'aptHash {}' | tr '\n' '-' | md5sum | cut -f 1 -d ' ')
          echo "key=apt-cache-$hash" >> $GITHUB_OUTPUT

      - name: Cache apt .deb files
        uses: actions/cache@v4
        with:
          path: .aptcache
          key: ${{ steps.aptcachekey.outputs.key }}
          restore-keys: |
            apt-cache-

      - name: Restore cached .deb files
        run: |
          sudo apt-get clean -yq
          if compgen -G ".aptcache/*.deb" > /dev/null; then
            sudo cp -l .aptcache/*.deb /var/cache/apt/archives
          fi

      - name: Install QEMU, libvirt, and dependencies
        id: qemu_apt
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86 qemu-system-arm qemu-system-aarch64 qemu-user-static qemu-utils ovmf \
            qemu-kvm \
            libvirt-daemon-system libvirt-clients \
            bridge-utils ebtables dnsmasq-base
          if command -v qemu-system-x86_64 >/dev/null 2>&1; then
            echo "QEMU installed via apt-get."
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "QEMU install via apt-get failed."
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Save new .deb files to cache
        run: |
          mkdir -p .aptcache
          sudo cp -l /var/cache/apt/archives/*.deb .aptcache || true

      - name: Install QEMU from source (fallback)
        if: steps.qemu_apt.outputs.success == 'false'
        uses: arceos-org/setup-qemu@v1.0.2
        with:
          version: '10.1.2'
          targets: 'x86_64,aarch64,arm'

      - name: Detect providers and install plugins
        id: providers
        run: |
          providers=""
          if command -v vboxmanage >/dev/null 2>&1; then
            vagrant plugin install vagrant-vbguest || true
            providers="virtualbox"
          fi
          if command -v docker >/dev/null 2>&1; then
            vagrant plugin install vagrant-docker-compose || true
            if [[ -n "$providers" ]]; then
              providers="$providers docker"
            else
              providers="docker"
            fi
          fi
          if command -v qemu-system-x86_64 >/dev/null 2>&1; then
            vagrant plugin install vagrant-qemu || true
            if [[ -n "$providers" ]]; then
              providers="$providers qemu"
            else
              providers="qemu"
            fi
          fi
          if command -v virsh >/dev/null 2>&1; then
            # Ensure libvirt development files are present for vagrant-libvirt plugin
            sudo apt-get update
            sudo apt-get install -y libvirt-dev
            vagrant plugin install vagrant-libvirt || true
            if [[ -n "$providers" ]]; then
              providers="$providers libvirt"
            else
              providers="libvirt"
            fi
          fi
          echo "providers=$providers" >> $GITHUB_OUTPUT

      - name: Find Vagrantfiles to test or generate from box
        id: vagrantfiles
        run: |
          set -e
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ -n "${{ github.event.inputs.box_name }}" ]]; then
              # Generate a temporary Vagrantfile for the given box
              mkdir -p .ci-tmp
              cat > .ci-tmp/Vagrantfile <<EOF
              Vagrant.configure("2") do |config|
                config.vm.box = "${{ github.event.inputs.box_name }}"
              end
              EOF
              echo "Manual run: using generated Vagrantfile for box ${{ github.event.inputs.box_name }}"
              echo "files=.ci-tmp/Vagrantfile" >> $GITHUB_OUTPUT
            elif [[ -n "${{ github.event.inputs.vagrantfile_path }}" ]]; then
              echo "Manual run: using input Vagrantfile path"
              echo "files=${{ github.event.inputs.vagrantfile_path }}" >> $GITHUB_OUTPUT
            else
              echo "Error: On workflow_dispatch, either vagrantfile_path or box_name must be provided." >&2
              exit 1
            fi
          else
            git fetch origin ${{ github.event.before }}
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'Vagrantfile$' > changed_vagrantfiles.txt || true
            cat changed_vagrantfiles.txt
            echo "files=$(cat changed_vagrantfiles.txt | xargs)" >> $GITHUB_OUTPUT
          fi
          

      - name: Install jq for box metadata parsing
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          else
            echo "jq already installed"
          fi

      - name: Test Vagrant up/halt/destroy for each provider
        env:
          PROVIDERS: ${{ steps.providers.outputs.providers }}
          FILES: ${{ steps.vagrantfiles.outputs.files }}
        run: |
          set -e
          if [[ -z "$FILES" ]]; then
            echo "No Vagrantfiles to test."
            exit 0
          fi
          get_host_arch() {
            uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/'
          }
          host_arch=$(get_host_arch)
          for file in $FILES; do
            dir=$(dirname "$file")
            echo "Testing Vagrantfile in $dir"
            # Try to extract box name and version from Vagrantfile
            box_name=$(grep -Eo 'config.vm.box\s*=\s*"[^"]+"' "$file" | head -1 | cut -d'"' -f2)
            box_version=$(grep -Eo 'config.vm.box_version\s*=\s*"[^"]+"' "$file" | head -1 | cut -d'"' -f2)
            if [[ -z "$box_name" ]]; then
              echo "No box name found in $file, skipping arch/provider check."
              box_name=""
            fi
            for provider in $PROVIDERS; do
              echo "Testing provider: $provider"
              # Only check if box_name is set and is a cloud box
              if [[ -n "$box_name" && "$box_name" == */* ]]; then
                api_url="https://vagrantcloud.com/api/v2/vagrant/${box_name}"
                echo "Checking box metadata: $api_url"
                box_json=$(curl -s "$api_url")
                # Find the version block
                if [[ -n "$box_version" ]]; then
                  version_json=$(echo "$box_json" | jq -c --arg ver "$box_version" '.versions[] | select(.version==$ver)')
                else
                  version_json=$(echo "$box_json" | jq -c '.versions[0]')
                fi
                # Check if provider/arch is supported
                match=$(echo "$version_json" | jq -r --arg provider "$provider" --arg arch "$host_arch" '.providers[] | select(.name==$provider and .architecture==$arch) | .architecture')
                if [[ -z "$match" ]]; then
                  echo "Skipping $box_name for provider $provider on $host_arch: not supported."
                  continue
                fi
              fi
              cd "$dir"
              vagrant up --provider=$provider || { echo "vagrant up failed for $provider in $dir"; exit 1; }
              vagrant status
              vagrant halt || { echo "vagrant halt failed for $provider in $dir"; exit 1; }
              vagrant destroy -f || { echo "vagrant destroy failed for $provider in $dir"; exit 1; }
              cd -
            done
          done
