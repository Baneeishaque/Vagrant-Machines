name: Vagrantfile CI Test
on:
  push:
    paths:
      - '**/Vagrantfile'
      
  workflow_dispatch:
    inputs:
      vagrantfile_path:
        description: 'Path to the Vagrantfile to test (relative to repo root)'
        required: false
        default: ''
      box_name:
        description: 'Vagrant Cloud box name (e.g. cloudicio/ubuntu-desktop) to test (overrides vagrantfile_path)'
        required: false
        default: ''
      box_version:
        description: 'Vagrant Cloud box version (optional, used with box_name)'
        required: false
        default: ''
      os:
        description: 'OS to run on'
        required: true
        default: 'both'
        type: choice
        options:
          - ubuntu-latest
          - macos-latest
          - both

jobs:
  vagrant-test:
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson('{"ubuntu-latest":["ubuntu-latest"],"macos-latest":["macos-latest"],"both":["ubuntu-latest","macos-latest"]}')[github.event.inputs.os] }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Only run apt cache steps on Ubuntu
      - name: Calculate apt cache key
        if: runner.os == 'Linux'
        id: aptcachekey
        run: .github/scripts/calc_apt_cache_key.sh
        shell: bash

      - name: Cache apt .deb files
        if: runner.os == 'Linux'
        uses: actions/cache@v4
        with:
          path: .aptcache
          key: ${{ steps.aptcachekey.outputs.key }}
          restore-keys: |
            apt-cache-

      - name: Restore cached .deb files
        if: runner.os == 'Linux'
        run: .github/scripts/restore_apt_cache.sh
        shell: bash

      - name: Find Vagrantfiles to test or generate from box
        id: vagrantfiles
        run: |
          export GITHUB_EVENT_NAME="${{ github.event_name }}"
          export BOX_NAME="${{ github.event.inputs.box_name }}"
          export BOX_VERSION="${{ github.event.inputs.box_version }}"
          export VAGRANTFILE_PATH="${{ github.event.inputs.vagrantfile_path }}"
          export GITHUB_BEFORE="${{ github.event.before }}"
          export GITHUB_SHA="${{ github.sha }}"
          .github/scripts/find_vagrantfiles.sh
        shell: bash

      - name: Test Vagrant up/halt/destroy for each supported provider
        run: |
          set -e
          get_host_arch() {
            uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/'
          }
          host_arch=$(get_host_arch)
          for file in ${{ steps.vagrantfiles.outputs.files }}; do
            .github/scripts/vagrant_test_matrix.sh "$file" "$host_arch" "${{ github.event.inputs.box_version }}"
          done
        shell: bash

      - name: Save new .deb files to cache
        if: runner.os == 'Linux'
        run: .github/scripts/save_apt_cache.sh
        shell: bash
